<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar producto</title>

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f2f0f0;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 70%;
            height: 750px;
            margin: 50px auto;
            background-color: #f2f0f0;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            align-items: center;
        }

        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .title {
            font-size: 24px;
            color: #df8755;
            font-weight: bold;
        }

        .bar {
            background-color: #df8755;
            height: 5px;
            margin: 10px 0;
        }

        .vista{
            margin-left:20px;
            margin-top: 10px;
        }

        label {
            font-size: 16px;
            font-weight: bold;
            color: #df8755;
            margin-top: 10px;
            display: block;
        }

        input[type="text"], input[type="number"], select {
            width: 95%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            color: #989680;
        }

        .button-container {
            margin-top: 30px;
            text-align: center;
            display: flex;
            gap: 25px;
            justify-content: center; /* Para centrar los botones horizontalmente */
            margin-top:125px;
        }

        button {
            background-color: #df8755;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #c56d4a;
        }

        .error {
            color: red;
            font-size: 12px;
        }

        /* Estilo para el mensaje emergente */
        #mensajeEmergente {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #df8755;
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
        }
        #mensajeEmergente.visible {
            display: block;
        }
        .contenedor{
            margin-bottom: 90px;
            margin-top: 5px;
        }
        .izquierda{
            width: 45%;
            float: left;
            margin: 0 auto;
        }
        .derecha{
            width: 45%;
            float: right;
            margin-right: 13px;
        }
        .campo_derecho{
            width: 45%;
            margin-left: 75px;
        }
        .campo_izquierdo{
            width: 500px;
            height: 450px;
            background: white;
            position: absolute;
            right: 350px; /* Alinea el contenedor de imágenes a la derecha */
            top: 180px; /* Baja el contenedor 180px desde la parte superior */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centra los elementos hijos horizontalmente */
            justify-content: center; /* Centra los elementos hijos verticalmente */

        }
        .imagen-principal  {
              width: 86%;
            height: 65%; /* Establece una altura fija o relativa para que la imagen se adapte */
            background: #d3d3d3;
            margin-top: 0;
            position: relative; /* Necesario para que el posicionamiento absoluto funcione correctamente */
            overflow: hidden;
        }
         .imagen-principal img{
              width: 100%;
            height: 100%;
            object-fit: contain;
         }
        .imagen-menu {
            margin-top: 10px;
            background: #d3d3d3;
            width: 86%;
            height: 22%;
            display:flex;
            flex-direction:row;
            justify-content: center;
             flex-wrap: wrap;
        }

        .imagen-menu img {
            width: 90px; /* Tamaño de las miniaturas */
            height: 90px;
            margin: 5px; /* Espacio entre las miniaturas */
            border-radius: 3px;
            cursor: pointer;

        }
        .botonSubir{
            position: absolute;
            right: 29%;
            top: 68%;

            width: 90px;
            height: 40px;

            background-image: url("static/subir.png"); /* Ruta de la imagen de fondo */
            background-size: cover;
            background-position: center;
            border: none;
            cursor: pointer;
        }

        input{
            text-align: center;
        }
        ::placeholder{
            color: #989680;
        }

    </style>

</head>
<body>
    <div class="container">
        <div class="header">
            <!-- <span class="title">Registrar Producto</span> -->
        </div>

        <div class="bar"></div>

        <h2 style="text-align:center; color:#df8755;">REGISTRAR NUEVO PRODUCTO</h2>

        <form id="registrar-producto-form" action="/registrar_producto" method="POST" enctype="multipart/form-data">
            <input type="hidden" id="id_usuario" name="id_usuario" value="{{ session['id_usuario'] }}">

            <div class="campo_derecho">
                <label for="nombre">Nombre del producto:</label>
                <input type="text" id="nombre" name="nombre" required placeholder="Campo obligatorio">
                <div id="error-nombre" class="error"></div>

                <label for="descripcion">Descripción:</label>
                <input type="text" id="descripcion" name="descripcion" required placeholder="Campo obligatorio">
                <div id="error-descripcion" class="error"></div>

                <div class="contenedor">
                    <div class="izquierda">
                        <label for="precio">Precio (Bs.):</label>
                        <input type="number" id="precio" name="precio" step="0.01" required placeholder="Campo obligatorio">
                        <div id="error-precio" class="error"></div>
                    </div>
                    <div class="derecha">
                        <label for="cantidad">Cantidad:</label>
                        <input type="number" id="cantidad" name="cantidad" required placeholder="Campo obligatorio">
                        <div id="error-cantidad" class="error"></div>
                    </div>
                </div>

                <label for="tipo_venta">Tipo de venta:</label>
                <select id="tipo_venta" name="tipo_venta" required>
                    <option value="Unitario" selected>Unitario</option>
                    <option value="Total">Total</option>
                </select>

                <label for="ubicacion">Ubicación:</label>
                <input type="text" id="ubicacion" name="ubicacion" required placeholder="Campo obligatorio">
                <div id="error-ubicacion" class="error"></div>

                <label for="tamano">Tamaño:</label>
                <input type="text" id="tamano" name="tamano" placeholder="Campo opcional">
                <div id="error-tamano" class="error"></div>

                <div class="contenedor">
                    <div class="izquierda">
                        <label for="marca">Marca:</label>
                        <input type="text" id="marca" name="marca" placeholder="Campo opcional">
                        <div id="error-marca" class="error"></div>
                    </div>
                    <div class="derecha">
                        <label for="color">Color:</label>
                        <input type="text" id="color" name="color" placeholder="Campo opcional">
                        <div id="error-color" class="error"></div>
                    </div>
                </div>
            </div>

            <div class="campo_izquierdo">
                <div class="imagen-principal">
                    <img id="imgPrincipal" src="" alt="Imagen Principal" style="display: none; width: 100%; height: auto; border-radius: 5px;" />
                </div>
                 <div class="imagen-menu" id="miniaturas">
                    <!-- Las miniaturas se agregarán aquí dinámicamente -->
                </div>

            </div>
            <input type="file" id="inputImagenes" accept="image/*" style="display: none;" multiple onchange="manejarImagenes(this.files)">
            <button type="button" class="botonSubir" onclick="abrirExplorador()"></button>

            <div class="button-container">
                <button type="button" id="botonRegistrar" onclick="validarFormulario(event)">Registrar Producto</button>
                 <button type="button" id="botonVista" onclick="vistaPreviaPublicacion(event)">Vista Previa</button>
                <button type="button" id="cancelar-button" onclick="limpiarFormulario()">Cancelar</button>
            </div>

        </form>
    </div>

    <!-- Mensaje emergente -->
    <div id="mensajeEmergente">Producto registrado exitosamente</div>

    <script> // Validaciones de cada campo del formulario de registro
        // Funcion para validar el campo de registro de nombre
        function validarNombre(){
            const nombre = document.getElementById('nombre').value;
            const errorNombre = document.getElementById('error-nombre');
            errorNombre.innerHTML = ''; // Limpiar mensajes previos
            let esValido = true;
            if (nombre.trim() === ""){
                errorNombre.innerHTML = 'El nombre del producto no puede estar vacío.';
                esValido = false;
            } else if (/\d/.test(nombre)){
                errorNombre.innerHTML = 'El nombre del producto no puede contener números.';
                esValido = false;
            } else if (/[^a-zA-Z\s]/.test(nombre)){
                errorNombre.innerHTML = 'El nombre del producto no puede contener caracteres especiales.';
                esValido = false;
            } else if (nombre.length < 3 || nombre.length > 25){
                errorNombre.innerHTML = 'El nombre del producto debe tener entre 3 y 25 caracteres.';
                esValido = false;
            }
            return esValido;
        }

        // Funcion para validar el campo de registro de descripciopn
        function validarDescripcion(){
            const descripcion = document.getElementById('descripcion').value;
            const errorDescripcion = document.getElementById('error-descripcion');
            errorDescripcion.innerHTML = ''; // Limpiar mensajes previos
            let esValido = true;
            // Verifica si el campo está vacío
            if (descripcion.trim() === ""){
                errorDescripcion.innerHTML = 'La descripción no puede estar vacía.';
                esValido = false;
            }// Verifica si la descripción contiene una mezcla de números y caracteres especiales
            else if (/[\d][^a-zA-Z0-9]+|[^a-zA-Z0-9]+[\d]/.test(descripcion)) {
                errorDescripcion.innerHTML = 'La descripción no puede tener una combinación de números y caracteres especiales.';
                esValido = false;
            }
            // Verifica si la descripción solo tiene números
            else if (/^\d+$/.test(descripcion)){
                errorDescripcion.innerHTML = 'La descripción no puede contener solo números.';
                esValido = false;
            }
            // Verifica si la descripción solo tiene caracteres especiales
            else if (/^[^a-zA-Z0-9]+$/.test(descripcion)){
                errorDescripcion.innerHTML = 'La descripción no puede contener solo caracteres especiales.';
                esValido = false;
            }
            // Verificar si la descripción tiene menos de 3 caracteres
            else if (descripcion.length < 3){
                errorDescripcion.innerHTML = 'La descripción debe tener al menos 3 caracteres.';
                esValido = false;
            }
            // Verifica si la descripción tiene más de 100 caracteres
            else if (descripcion.length > 100){
                errorDescripcion.innerHTML = 'La descripción no puede tener más de 100 caracteres.';
                esValido = false;
            }
            return esValido;
        }

        // Funcion para validar el campo de registro del precio
        function validarPrecio(){
            const precio = document.getElementById('precio').value;
            const errorPrecio = document.getElementById('error-precio');
            errorPrecio.innerHTML = ''; // Limpiar mensajes previos
            let esValido = true;
            const formatoPrecio = /^[0-9]+([.,][0-9]{1,2})?$/;
            if (precio.trim() === ""){
                errorPrecio.innerHTML = 'El campo de precio no puede estar vacío.';
                esValido = false;
            } else if (parseFloat(precio.replace(',', '.')) < 0) {
                errorPrecio.innerHTML = 'El precio no puede ser negativo.';
                esValido = false;
            } else if (!formatoPrecio.test(precio)){
                errorPrecio.innerHTML = 'El precio solo puede contener números, un punto o una coma con 2 decimales.';
                esValido = false;
            } else if (parseFloat(precio.replace(',', '.')) > 99999999){
                errorPrecio.innerHTML = 'El precio no puede ser mayor a 99,999,999.99.';
                esValido = false;
            }
            return esValido;
        }

        // Funcion para validar el campo de registro de cantidad
        function validarCantidad(){
            const cantidad = document.getElementById('cantidad').value;
            const errorCantidad = document.getElementById('error-cantidad');
            errorCantidad.innerHTML = ''; // Limpiar mensajes previos
            let esValido = true;
            if (cantidad.trim() === ""){
                errorCantidad.innerHTML = 'La cantidad no puede estar vacía.';
                esValido = false;
            } else if (parseInt(cantidad) <= 0){
                errorCantidad.innerHTML = 'La cantidad debe ser un número positivo.';
                esValido = false;
            }
            return esValido;
        }

        // Funcion para validar el campo de registro de ubicacion
        function validarUbicacion(){
            const ubicacion = document.getElementById('ubicacion').value;
            const errorUbicacion = document.getElementById('error-ubicacion');
            errorUbicacion.innerHTML = ''; // Limpiar mensajes previos
            let esValido = true;
            if (ubicacion.trim() === ""){
                errorUbicacion.innerHTML = 'La ubicación no puede estar vacía.';
                esValido = false;
            } else if (ubicacion.length < 3 || ubicacion.length > 100){
                errorUbicacion.innerHTML = 'La ubicación debe tener entre 3 y 100 caracteres.';
                esValido = false;
            }// Validar caracteres permitidos (letras, números, espacios, comas, y guiones)
            else if (!/^[a-zA-Z0-9\s,.-]+$/.test(ubicacion)){
                errorUbicacion.innerHTML = 'La ubicación solo puede contener letras, números, espacios, comas y guiones.';
                esValido = false;
            }
            // Validar que no contenga solo números
            else if (/^\d+$/.test(ubicacion)){
                errorUbicacion.innerHTML = 'La ubicación no puede contener solo números.';
                esValido = false;
            }
            return esValido;
        }

        // Funcion para validar el campo de registro de marca
        function validarMarca(){
            const marca = document.getElementById('marca').value;
            const errorMarca = document.getElementById('error-marca');
            errorMarca.innerHTML = ''; // Limpiar mensajes previos
            let esValido = true;
            if (marca.length > 25){
                errorMarca.innerHTML = 'La marca no puede tener más de 25 caracteres.';
                esValido = false;
            } else if (/\d/.test(marca)){
                errorMarca.innerHTML = 'La marca no puede contener números.';
                esValido = false;
            } else if (/[^a-zA-Z\s]/.test(marca)){
                errorMarca.innerHTML = 'La marca no puede contener caracteres especiales.';
                esValido = false;
            }
            return esValido;
        }

        // Funcion para validar el campo de registro de color
        function validarColor(){
            // Obtener el valor del color
            const color = document.getElementById('color').value;
            const errorColor = document.getElementById('error-color');
            errorColor.innerHTML = ''; // Limpiar los mensajes previos
            let esValido = true;
            // Verificar que solo existan caracteres alfabéticos
            if (/\d/.test(color)){
                errorColor.innerHTML = 'El color no puede contener números.';
                esValido = false;
            }else if (/[^a-zA-Z\s]/.test(color)){
                errorColor.innerHTML = 'El color no puede contener caracteres especiales.';
                esValido = false;
            }
            // Verificar si el color tiene más de 20 caracteres
            else if (color.length > 20){
                errorColor.innerHTML = 'El color no puede tener más de 20 caracteres.';
                esValido = false;
            }
            return esValido;
        }

        // Funcion para validar el campo de registro de tamaño
        function validarTamano(){
            const tamano = document.getElementById('tamano').value;
            const errorTamano = document.getElementById('error-tamano');
            errorTamano.innerHTML = ''; // Limpiar los mensajes previos
            let esValido = true;

            // Expresión regular que permite letras, números, espacios y algunas palabras clave como "de", "x"
            const formatoTamanoFlexible = /^[a-zA-Z0-9\s]+$/;

            if (tamano.trim() === "") {
                return esValido; // Salir de la función sin validar si está vacío (opcional)
            }
            // Verificar si el tamaño tiene más de 50 caracteres
            if (tamano.length > 50) {
                errorTamano.innerHTML = 'El tamaño no puede tener más de 50 caracteres.';
                esValido = false;
            }
            // Verificar si el formato del tamaño es incorrecto
            else if (!formatoTamanoFlexible.test(tamano)) {
                errorTamano.innerHTML = 'El tamaño solo puede contener letras, números y espacios. No se permiten caracteres especiales.';
                esValido = false;
            }
            return esValido;
        }

        // Creacion de la funcion para validar todo el formulario
        function validarFormulario(event){
            event.preventDefault(); // Evitar el envío del formulario por defecto

            const esNombreValido = validarNombre();
            const esDescripcionValido = validarDescripcion();
            const esPrecioValido = validarPrecio();
            const esCantidadValido = validarCantidad();
            const esUbicacionValido = validarUbicacion();
            const esMarcaValido = validarMarca();
            const esColorValido = validarColor();
            const esTamanoValido = validarTamano();

            // Verificar si al menos una imagen ha sido cargada
            if (base64Images.length === 0) {
                mostrarMensajeEmergente("Debes agregar al menos una imagen antes de enviar el formulario.");
                return; // Detener la función para evitar el envío
            }

            if (esNombreValido && esDescripcionValido && esPrecioValido && esCantidadValido && esUbicacionValido && esMarcaValido && esColorValido && esTamanoValido) {
                // Crear un objeto FormData para enviar el formulario
                const formData = new FormData(document.getElementById('registrar-producto-form'));

                // Agregar las imágenes al FormData
                const inputImagenes = document.getElementById('inputImagenes');
                for (let i = 0; i < inputImagenes.files.length; i++) {
                    formData.append('imagenes', inputImagenes.files[i]); // 'imagenes' es la clave
                }

                fetch('/registrar_producto', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json()) // Analizar la respuesta JSON
                .then(data => {
                    // Mostrar el mensaje de éxito
                    mostrarMensajeEmergente(data.message, true);
                    // Limpiar el formulario después de guardar
                    limpiarFormulario();
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarMensajeEmergente('Hubo un error al guardar el producto. Intenta nuevamente.');
                });
            }
        }

        const base64Images = []; // Array global para almacenar imágenes en base64

        function abrirExplorador() {
            document.getElementById('inputImagenes').click(); // Simula el clic en el input
        }

        const MAX_FILE_SIZE = 5 * 1024 * 1024; // Tamaño máximo permitido en bytes (5MB)
        const MAX_WIDTH = 600; // Ancho máximo en píxeles
        const MAX_HEIGHT = 400; // Alto máximo en píxeles

        function manejarImagenes(files) {
            if (!files.length) return;
            // Verificar el límite total de 5 imágenes
            if (files.length + base64Images.length > 5) {
                alert(`Puedes agregar hasta ${5 - base64Images.length} imágenes más.`);
                return;
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // Validar extensión de archivo
                const validExtensions = ['.png', '.jpg'];
                const fileExtension = file.name.slice(((file.name.lastIndexOf(".") - 1) >>> 0) + 2).toLowerCase();
                if (!validExtensions.includes(`.${fileExtension}`)) {
                    alert("Solo se permiten imágenes en formato PNG o JPG.");
                    continue; // Salta al siguiente archivo
                }

                // Validar tamaño de archivo
                if (file.size > MAX_FILE_SIZE) {
                    alert(`El archivo "${file.name}" supera el tamaño máximo permitido de 5MB.`);
                    continue;
                }
                
                const reader = new FileReader();
                // Antes de cargar la imagen, validamos si ya existe en `base64Images`
                reader.onload = function(event) {
                    const base64Image = event.target.result;
                    // Verificar si la imagen es duplicada
                    if (base64Images.includes(base64Image)) {
                        alert(`La imagen "${file.name}" ya ha sido cargada.`);
                        return;
                    }
                    const img = new Image();
                    img.src = base64Image;

                    // Verificar dimensiones de la imagen cuando se cargue
                    img.onload = function() {
                        if (img.width > MAX_WIDTH || img.height > MAX_HEIGHT) {
                            alert(`La imagen "${file.name}" supera las dimensiones máximas permitidas de ${MAX_WIDTH}x${MAX_HEIGHT} píxeles.`);
                            return;
                        }

                        // Mostrar la primera imagen seleccionada como principal si está vacía
                        if (base64Images.length === 0) {
                            mostrarImagenPrincipal(base64Image);
                        }

                        // Agregar la imagen a la lista y mostrar miniatura con opción de eliminar
                        base64Images.push(base64Image);
                        agregarMiniatura(base64Image);
                    };    
                };
                reader.readAsDataURL(file);
            }
        }

        function mostrarImagenPrincipal(file) {
            const imgPrincipal = document.getElementById('imgPrincipal');
            const reader = new FileReader();

            reader.onload = function(event) {
                imgPrincipal.src = event.target.result; // Mostrar la imagen principal
                imgPrincipal.style.display = 'block'; // Hacer visible la imagen principal
            };

            reader.readAsDataURL(file); // Leer la imagen como URL
        }

        function agregarMiniatura(src) {
            const miniaturasDiv = document.getElementById('miniaturas');

            // Verifica que no se exceda el límite de 5 miniaturas
            if (miniaturasDiv.children.length < 5) {
                const miniatura = document.createElement('img');
                miniatura.src = src; // Establecer la miniatura
                miniatura.onclick = function() {
                    // Cambiar la imagen principal al hacer clic en la miniatura
                    mostrarImagenPrincipal(src); // Cambiar imagen principal
                };

                miniaturasDiv.appendChild(miniatura); // Agregar la miniatura al contenedor
            }
        }





        // Funcion para mostrar el mesaje emergente
        function mostrarMensajeEmergente(mensaje, esExitoso = false){
            const mensajeEmergente = document.getElementById('mensajeEmergente');
            if (mensajeEmergente) {
                mensajeEmergente.innerText = mensaje; // Actualizar el mensaje
                mensajeEmergente.classList.add('visible');
                // Solo redirigir si es un mensaje de éxito
                if (esExito) {
                    setTimeout(() => {
                        mensajeEmergente.classList.remove('visible');
                        // Redirigir a la pantalla principal después de 3 segundos
                        window.location.href = '/index';
                    }, 3000); // Desaparecer después de 3 segundos
                } else {
                    // Para los mensajes de error, simplemente desaparecer después de 3 segundos
                    setTimeout(() => {
                        mensajeEmergente.classList.remove('visible');
                    }, 3000); // Desaparecer después de 3 segundos
                }
            }
        }

        // Funcion para limpiar el formulario al dar clik en cancelar
        function limpiarFormulario() {
            document.getElementById('registrar-producto-form').reset();
            document.querySelectorAll('.error').forEach(e => e.innerHTML = '');
        }

        // Asignar el evento input para validar en tiempo real
        document.getElementById('nombre').addEventListener('input', validarNombre);
        document.getElementById('descripcion').addEventListener('input', validarDescripcion);
        document.getElementById('precio').addEventListener('input', validarPrecio);
        document.getElementById('cantidad').addEventListener('input', validarCantidad);
        document.getElementById('ubicacion').addEventListener('input', validarUbicacion);
        document.getElementById('marca').addEventListener('input', validarMarca);
        document.getElementById('color').addEventListener('input', validarColor);
        document.getElementById('tamano').addEventListener('input', validarTamano);



    </script>

</body>
</html>
