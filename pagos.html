<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formas de Pago</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f2f0f0;
        }

        .container {
            width: 80%;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .titulo {
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
        }

        .buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .button, .realizarPago{
            margin: 0 40px;
            padding: 10px 20px;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .realizarPago{
            display: block;
            margin: 0 auto;
        }

        .button:hover {
            background-color: #d35400;
        }

        .pestanas{
            display: none;
        }

        .activo{
            display: block;
        }

        .instrucciones{
            width: 45%;
            height: 200px;
            background-color: #f2f0f0;
            padding: 20px 30px;
            font-size: 17px;
        }

        .qr{
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .imgQR{
            width: 50%;
            text-align: center;
        }
        #imagen{
            width: 300px;
            height: 300px;
            padding: 20px;
        }
        .formTB{
            padding: 30px;
            display: flex;
            flex-direction: column;
        }
        #c1{margin-left: 100px;} #c2{margin-left: 240px;} #c3{margin-left: 20px;}
        #c4{margin-left: 100px;} #c5{margin-left: 45px;} #c6{margin-left: 250px;}
        .etiCampo{
            font-size: 25px;
            font-weight: bold;
            padding: 20px 0;
            text-align: right;
        }
        .inputText{
            height: 40px;
            margin: 20px 20px;
            width: 400px;
            background-color: #e7e7e7;
            border-radius: 20px;
            padding: 8px;
            font-size: 25px;
        }
        .campoTB{
            display: flex;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 250px;
            height: 130px;
            position: relative;
            font-size: 1.2rem;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background-color: #f7d78c;
            padding: 0.5rem 1rem;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
            color: black;
        }

        .modal-body {
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            color: black;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="titulo">Formas de Pago</h2>
        <div class="buttons">
            <button class="button" onclick="mostrarSeccion('pagoQR')">QR</button>
            <button class="button" onclick="mostrarSeccion('transBanc')">Transferencia Bancaria</button>
            <button class="button" onclick="mostrarSeccion('pagoTarCred')">Tarjeta de Crédito</button>
        </div>
        <div class="pestanas" id="pagoQR">
            <div class="qr">
                <div class="instrucciones">
                    <p>1. Abra la aplicación movil de su banco en su teléfono celular.</p>
                    <p>2. Seleccione la forma de pago QR-SIMPLE.</p>
                    <p>3. Capture el siguiente código QR con la cámara de su teléfono.</p>
                    <p>4. Espere algunos segundos para que se confirme su pago</p>
                </div>
                <div class="imgQR">
                    <div class="imagen">
                        <img src="" alt="QR Code" id="imagen">
                    </div>
                </div>
            </div>
            <button class="realizarPago" onclick="validarPagoQR()">Realizar Pago</button>
        </div>
        <div class="pestanas" id="transBanc">
           <form id="formTransferencia" class="formTB" onsubmit="return validarTransferencia(event)">
                <div class="campoTB">
                    <p class="etiCampo" id="c1">Número de cuenta:</p>
                    <input type="text" id="numeroCuenta" class="inputText" placeholder="Ingrese su número de cuenta">
                </div>
                <div class="campoTB">
                    <p class="etiCampo" id="c2">Banco:</p>
                    <input type="text" id="banco" class="inputText" placeholder="Ingrese su banco">
                </div>
                <div class="campoTB">
                    <p class="etiCampo" id="c3">Número de referencia:</p>
                    <input type="text" id="numeroReferencia" class="inputText" placeholder=" ">
                </div>
                <button type="submit" class="realizarPago">Confirmar transferencia</button>
            </form>
        </div>
        <div class="pestanas" id="pagoTarCred">
            <form id="formTarCredito" class="formTB" onsubmit="return validarTarjetaCredito(event)">
                <div class="campoTB">
                    <p class="etiCampo" id="c4">Número de tarjeta:</p>
                    <input type="text" id="numeroTarjeta" class="inputText" placeholder="Ingrese su número de tarjeta">
                </div>
                <div class="campoTB">
                    <p class="etiCampo" id="c5">Fecha de vencimiento:</p>
                    <input type="text" id="fechaVencimiento" class="inputText" placeholder="MM/AA">
                </div>
                <div class="campoTB">
                    <p class="etiCampo" id="c6">CVV:</p>
                    <input type="text" id="cvv" class="inputText" placeholder="Ingrese su CVV">
                </div>
                <button type="submit" class="realizarPago">Realizar pago</button>
            </form>
        </div>
        <div id="modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <button class="close-button" onclick="cerrarModal()">&times;</button>
                </div>
                <div class="modal-body" id="modal-message"></div>
            </div>
        </div>
    </div>
    <script>
        if (location.protocol !== 'https:') {
            // Redirige automáticamente a la versión HTTPS
            location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        }

        const userId = {{ session['id_usuario'] }};
        const confirmarCompraUrl = "{{ url_for('confirmar_compra', user_id=session['id_usuario']) }}";

        const imagenes = [
            "static/QRFlor.jpeg",
            "static/QRMile.jpeg",
            "static/QRJosue.jpeg",
            "static/QR1.jpeg",
            "static/QR2.jpeg",
            "static/QRJuaquin.jpeg",
            "static/QRPedro.jpeg"
        ];

        const imagenAleatoria = imagenes[Math.floor(Math.random() * imagenes.length)];
        document.getElementById('imagen').src = imagenAleatoria;

        function limpiarFormulario(formId) {
            const form = document.getElementById(formId);
            if (form) {
                form.reset();
            }
        }

        function mostrarSeccion(id) {
            const pestanas = document.getElementsByClassName('pestanas');
            for (let i = 0; i < pestanas.length; i++) {
                pestanas[i].classList.remove('activo');
                if (pestanas[i].id !== id) {
                    const form = pestanas[i].querySelector('form');
                    if (form) {
                        limpiarFormulario(form.id);
                    }
                }
            }
            const pestanaActiva = document.getElementById(id);
            pestanaActiva.classList.add('activo');

            // Añadir lógica de temporizador específica para QR
            if (id === 'pagoQR') {
                iniciarTemporizadorQR();
            }
        }

        function mostrarModal(mensaje) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');

            modalMessage.textContent = mensaje;
            modal.style.display = 'flex';
        }

        // Función para cerrar el modal
        function cerrarModal() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none';
        }

        function validarTransferencia(event) {
            event.preventDefault();

            const numeroCuenta = document.getElementById('numeroCuenta');
            const banco = document.getElementById('banco');
            const numeroReferencia = document.getElementById('numeroReferencia');

            if (!numeroCuenta.value.trim()) {
                mostrarModal('El número de cuenta es obligatorio.');
                return false;
            }
            if (!banco.value.trim()) {
                mostrarModal('El banco es obligatorio.');
                return false;
            }
            if (!/^\d+$/.test(numeroCuenta.value)) {
                mostrarModal('El número de cuenta solo debe contener números.');
                return false;
            }
            if (!/^[a-zA-Z\s]+$/.test(banco.value)) {
                mostrarModal('El campo banco solo debe contener letras.');
                return false;
            }
            if (numeroReferencia.value.trim() && !/^\d+$/.test(numeroReferencia.value)) {
                mostrarModal('El número de referencia solo debe contener números.');
                return false;
            }
            fetch('/guardar_pago', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id_usuario: userId,
                    metodo_pago: 'Transferencia Bancaria',
                    num_transaccion: null
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.success) {
                    mostrarModal('Transacción exitosa.');
                    setTimeout(() => {
                        window.location.href = confirmarCompraUrl;
            }, 1500);
                } else {
                     mostrarModal(`Error al registrar el pago: ${data.message}`);
                }
            });
            return false;
        }

        document.getElementById('fechaVencimiento').addEventListener('input', function () {
        let valor = this.value.replace(/\D/g, ''); // Elimina caracteres no numéricos
        if (valor.length >= 2) {
        valor = valor.slice(0, 2) + '/' + valor.slice(2); // Inserta la barra después de los primeros dos dígitos
        }
            this.value = valor;
        });
        
        function validarTarjetaCredito(event) {
            event.preventDefault();

            const numeroTarjeta = document.getElementById('numeroTarjeta');
            const fechaVencimiento = document.getElementById('fechaVencimiento');
            const cvv = document.getElementById('cvv');

            if (!numeroTarjeta.value.trim()) {
                mostrarModal('El número de tarjeta es obligatorio.');
                return false;
            }
            if (!/^\d{16}$/.test(numeroTarjeta.value)) {
                mostrarModal('El número de tarjeta debe tener 16 dígitos.');
                return false;
            }
            if (!fechaVencimiento.value.trim()) {
                mostrarModal('La fecha de vencimiento es obligatoria.');
                return false;
            }
            if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(fechaVencimiento.value)) {
                mostrarModal('La fecha de vencimiento debe estar en el formato MM/AA.');
                return false;
            }
            if (!cvv.value.trim()) {
                mostrarModal('El CVV es obligatorio.');
                return false;
            }
            if (!/^\d{3}$/.test(cvv.value)) {
                mostrarModal('El CVV debe tener 3 dígitos.');
                return false;
            }
            fetch('/guardar_pago', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id_usuario: userId, // ID del usuario
                    metodo_pago: 'Tarjeta de Crédito',
                    num_transaccion: null // Num. de transacción nulo
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data); // Verifica la respuesta del servidor
                if (data.success) {
                    mostrarModal('Transacción exitosa.');
                    setTimeout(() => {
                        window.location.href = confirmarCompraUrl;
            }, 1500);
                } else {
                    mostrarModal(`Error al registrar el pago: ${data.message}`);
                }
            });
            return false;
        }

        function iniciarTemporizadorQR() {
            if (window.qrTimeoutId) {
                clearTimeout(window.qrTimeoutId);
            }

            window.qrTimeoutId = setTimeout(() => {
                const pestanaQR = document.getElementById('pagoQR');
                if (pestanaQR && pestanaQR.classList.contains('activo')) {
                    mostrarModal('Transacción fallida.');
                    
                    setTimeout(() => {
                        const imagen = document.getElementById('imagen');
                        if (imagen) {
                            imagen.src = imagenes[Math.floor(Math.random() * imagenes.length)];
                        }
                        mostrarSeccion('pagoQR');
                    }, 1500); 
                }
            }, 10000); // 10 segundos
        }
        
        function validarPagoQR() {
            // Limpiar el temporizador si el usuario hace clic en realizar pago antes
            if (window.qrTimeoutId) {
                clearTimeout(window.qrTimeoutId);
            }

            fetch('/guardar_pago', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id_usuario: userId,
                    metodo_pago: 'QR',
                    num_transaccion: null
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.success) {
                    mostrarModal('Transacción exitosa.');
                    setTimeout(() => {
                        window.location.href = confirmarCompraUrl;
                    }, 1500);
                } else {
                    mostrarModal(`Error al registrar el pago: ${data.message}`);
                }
            })
            .catch(error => {
                mostrarModal('Error de conexión.');
            });

            return false;
        }
    </script>
</body>
</html>
